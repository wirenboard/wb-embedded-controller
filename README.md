# Wiren Board Embedded Controller

## Описание

Wiren Board Embedded Controller (EC) — это микроконтроллер STM32G030C8, который управляет питанием и другими системными функциями контроллера Wiren Board начиная с ревизии 7.4.

В данном репозитории находится исходный код прошивки EC, а также инструкции по обновлению прошивки.

В прошивке реализованы следующие функции:

- RTC - часы реального времени
- Watchdog - сторожевой таймер, который перезагружает контроллер Wiren Board, если он завис
- Управление питанием контроллера - включение, выключение, перезагрузка, пробуждение по будильнику
- Измерение температуры платы
- Управление выходом Vout
- Обработка нажатий на кнопку ON/OFF

Подробнее о функциях EC можно прочитать в wiki [Wiren Board Embedded Controller](https://wirenboard.com/wiki/Wiren_Board_Embedded_Controller).

## Сборка прошивки

Для сборки прошивки требуется установить компилятор `arm-none-eabi-gcc` и утилиту `make`.

Сборка производится командой `make`:

```bash
git clone git@github.com:wirenboard/wb-embedded-controller.git
cd wb-embedded-controller
make
```

## Архитектура

В проекте не используется операционная система, весь код выполняется в основном цикле программы.

Основной алгоритм работы реализован в файле `wbec.c`. В этом файле происходит взаимодействие с периферией и другими подсистемами контроллера.

Взаимодействие между контроллером Wiren Board и EC происходит по шине SPI. Используется режим SPI Mode 0 (CPOL=0, CPHA=0). Рекомендуемая частота шины - до 1 МГц. Все команды и данные передаются в формате little-endian. Размер передаваемых данных - 16 бит.

Поддерживаются 2 операции: чтение и запись регистров. Более подробное описание можно найти в файле `spi-slave.c`. Карта регистров находится в файле `regmap-structs.h`.

## Поддержка в ядре Linux

В [ядро Linux контроллера Wiren Board](https://github.com/wirenboard/linux) добавлена поддержка EC. Для взаимодействия с EC используется `mfd` драйвер `wirenboard,wbec`. Драйвер реализует интерфейс `regmap` для доступа к регистрам EC. Также добавлены драйверы для RTC, watchdog и остальных подсистем EC. Найти их можно по ключевому слову `wbec`.

## Обновление прошивки EC

Для обновления прошивки используется встроенный в STM32G030C8 загрузчик. Прошивка загружается через интерфейс I2C.

Для запуска процесса обновления в Linux сначала необходимо применить device tree overlay, который настраивает I2C и GPIO для работы с загрузчиком. После этого можно обновить прошивку с помощью утилиты stm32flash.

Процесс обновления прошивки автоматизирован в скрипте `tools/wb-ec-firmware-update`. Скрипт выполняет все необходимые действия для обновления прошивки EC.
